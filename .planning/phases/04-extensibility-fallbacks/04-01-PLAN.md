---
phase: 04-extensibility-fallbacks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Router/RewriteHandler.php
  - src/Discovery/AlternateLinkHandler.php
autonomous: true

must_haves:
  truths:
    - "Visiting /post-slug/?format=markdown returns markdown content"
    - "Developer can add custom post types via filter hook"
    - "Custom post type with filter enabled serves markdown at .md URL"
    - "Custom post type with filter enabled shows alternate link in head"
  artifacts:
    - path: "src/Router/RewriteHandler.php"
      provides: "Format query parameter handling and filterable post type support"
      contains: "markdown_alternate_supported_post_types"
    - path: "src/Discovery/AlternateLinkHandler.php"
      provides: "Filterable post type support for alternate links"
      contains: "markdown_alternate_supported_post_types"
  key_links:
    - from: "src/Router/RewriteHandler.php"
      to: "apply_filters()"
      via: "get_supported_post_types() method"
      pattern: "apply_filters.*markdown_alternate_supported_post_types"
    - from: "src/Discovery/AlternateLinkHandler.php"
      to: "apply_filters()"
      via: "get_supported_post_types() method"
      pattern: "apply_filters.*markdown_alternate_supported_post_types"
    - from: "src/Router/RewriteHandler.php"
      to: "get_query_var('format')"
      via: "handle_format_parameter() method"
      pattern: "get_query_var.*format"
---

<objective>
Add query parameter fallback (`?format=markdown`) and filterable custom post type support.

Purpose: Enable markdown access for clients that cannot send Accept headers and allow developers to extend markdown support to custom post types via a filter hook.

Output: Updated RewriteHandler.php with format parameter handling and filterable post type checks; Updated AlternateLinkHandler.php with filterable post type checks.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-extensibility-fallbacks/04-CONTEXT.md
@.planning/phases/04-extensibility-fallbacks/04-RESEARCH.md
@src/Router/RewriteHandler.php
@src/Discovery/AlternateLinkHandler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add format query parameter fallback and filterable post types to RewriteHandler</name>
  <files>src/Router/RewriteHandler.php</files>
  <action>
Update RewriteHandler.php to add:

1. Register `format` query var in `add_query_vars()`:
   - Add `$vars[] = 'format';` alongside existing `markdown_request` var

2. Add private helper method `get_supported_post_types()`:
   ```php
   private function get_supported_post_types(): array {
       $default_types = ['post', 'page'];
       return apply_filters('markdown_alternate_supported_post_types', $default_types);
   }
   ```

3. Add private helper method `is_supported_post_type(string $post_type)`:
   ```php
   private function is_supported_post_type(string $post_type): bool {
       return in_array($post_type, $this->get_supported_post_types(), true);
   }
   ```

4. Add `handle_format_parameter()` method (registered at priority 1, BEFORE handle_accept_negotiation):
   - Skip if `markdown_request` query var is set (URL wins over query param)
   - Get `format` query var, skip if not exactly `markdown` (case-sensitive, strict equality)
   - Must be on singular content (`is_singular()`)
   - Get post via `get_queried_object()`, validate is WP_Post
   - Check post type is supported via `is_supported_post_type()`
   - Check post status is 'publish'
   - Handle password protection (403 response)
   - Serve markdown using ContentRenderer, same as handle_markdown_request()

5. Update `handle_markdown_request()`:
   - Replace hardcoded `in_array($post->post_type, ['post', 'page'], true)` with `$this->is_supported_post_type($post->post_type)`

6. Update `register()` to add format handler:
   - Add `add_action('template_redirect', [$this, 'handle_format_parameter'], 1);`
   - Must be registered BEFORE handle_accept_negotiation (both at priority 1, order of add_action calls determines order)

Important: The order must be: handle_format_parameter -> handle_accept_negotiation -> handle_markdown_request
Rationale: URL (.md) wins first (checked in all handlers), then query param (?format=markdown), then Accept header.
  </action>
  <verify>
1. Grep for `markdown_alternate_supported_post_types` in RewriteHandler.php
2. Grep for `get_query_var('format'` in RewriteHandler.php
3. Grep for `handle_format_parameter` in RewriteHandler.php
4. Confirm hardcoded ['post', 'page'] no longer appears in handle_markdown_request
  </verify>
  <done>
- Format query var registered
- Filter hook `markdown_alternate_supported_post_types` exists and returns default ['post', 'page']
- handle_format_parameter() processes ?format=markdown requests
- Post type checks use filterable is_supported_post_type() method
  </done>
</task>

<task type="auto">
  <name>Task 2: Add filterable post types to AlternateLinkHandler</name>
  <files>src/Discovery/AlternateLinkHandler.php</files>
  <action>
Update AlternateLinkHandler.php to use filterable post type support:

1. Add private helper method `get_supported_post_types()`:
   ```php
   private function get_supported_post_types(): array {
       $default_types = ['post', 'page'];
       return apply_filters('markdown_alternate_supported_post_types', $default_types);
   }
   ```

2. Add private helper method `is_supported_post_type(string $post_type)`:
   ```php
   private function is_supported_post_type(string $post_type): bool {
       return in_array($post_type, $this->get_supported_post_types(), true);
   }
   ```

3. Update `output_alternate_link()`:
   - Replace hardcoded `in_array($post->post_type, ['post', 'page'], true)` with `$this->is_supported_post_type($post->post_type)`

Note: Both RewriteHandler and AlternateLinkHandler will have their own copy of these helper methods. This is intentional duplication - a trait would add complexity for minimal benefit. The filter hook name is the contract; implementations are internal.
  </action>
  <verify>
1. Grep for `markdown_alternate_supported_post_types` in AlternateLinkHandler.php
2. Grep for `is_supported_post_type` in AlternateLinkHandler.php
3. Confirm hardcoded ['post', 'page'] no longer appears in output_alternate_link
  </verify>
  <done>
- Filter hook `markdown_alternate_supported_post_types` called in AlternateLinkHandler
- Post type check uses filterable is_supported_post_type() method
- Alternate links will appear for any post type added via filter
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify:
1. `grep -r "markdown_alternate_supported_post_types" src/` shows filter in both files
2. `grep -r "in_array.*'post'.*'page'" src/` returns NO matches (hardcoded arrays removed)
3. `grep "'format'" src/Router/RewriteHandler.php` shows format query var registration
4. Code review: handle_format_parameter serves markdown for singular posts with ?format=markdown
</verification>

<success_criteria>
1. URL-04 satisfied: Visiting `/post-slug/?format=markdown` returns markdown content (same as .md URL)
2. TECH-05 satisfied: Filter `markdown_alternate_supported_post_types` allows CPT extension
3. Existing functionality preserved: .md URLs and Accept header negotiation still work
4. CPT support is consistent: Both RewriteHandler and AlternateLinkHandler use the same filter
</success_criteria>

<output>
After completion, create `.planning/phases/04-extensibility-fallbacks/04-01-SUMMARY.md`
</output>
