---
phase: 03-content-negotiation-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Router/RewriteHandler.php
autonomous: true

must_haves:
  truths:
    - "Markdown response includes Vary: Accept header"
    - "Markdown response includes Content-Type: text/markdown; charset=UTF-8 header"
    - "Markdown response includes Link header with canonical HTML URL"
    - "Request with Accept: text/markdown on HTML URL returns 303 redirect to .md URL"
  artifacts:
    - path: "src/Router/RewriteHandler.php"
      provides: "Response headers and Accept header negotiation"
      contains: "Vary: Accept"
  key_links:
    - from: "handle_accept_negotiation()"
      to: "303 redirect"
      via: "status_header(303) + Location header"
      pattern: "status_header\\(303\\)"
---

<objective>
Add HTTP response headers and Accept header content negotiation to RewriteHandler.

Purpose: Enable proper HTTP semantics for markdown responses - caching works correctly with Vary header, clients can discover canonical HTML via Link header, and Accept header negotiation redirects to .md URLs.

Output: Extended RewriteHandler with response headers (Vary, Link, X-Content-Type-Options) and Accept header detection that issues 303 redirects.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-negotiation-discovery/03-CONTEXT.md
@.planning/phases/03-content-negotiation-discovery/03-RESEARCH.md
@src/Router/RewriteHandler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add response headers to markdown output</name>
  <files>src/Router/RewriteHandler.php</files>
  <action>
Add a private method `set_response_headers(WP_Post $post)` that sets all required HTTP headers for markdown responses:

1. Content-Type: text/markdown; charset=UTF-8 (already exists, move to this method)
2. Vary: Accept (required by TECH-04)
3. Link: <canonical-url>; rel="canonical" (from CONTEXT.md)
4. X-Content-Type-Options: nosniff (from CONTEXT.md)

Use `get_permalink($post)` for the canonical URL.

Update `handle_markdown_request()` to call this method instead of inline header calls.

Reference pattern from 03-RESEARCH.md Pattern 3.
  </action>
  <verify>
Read the updated RewriteHandler.php and confirm:
- `set_response_headers()` method exists
- All four headers are set
- `handle_markdown_request()` calls `set_response_headers()`
  </verify>
  <done>Markdown responses include all required HTTP headers (Content-Type, Vary, Link, X-Content-Type-Options)</done>
</task>

<task type="auto">
  <name>Task 2: Add Accept header negotiation with 303 redirect</name>
  <files>src/Router/RewriteHandler.php</files>
  <action>
Add a public method `handle_accept_negotiation()` that:

1. First checks if already a markdown request: `if (get_query_var('markdown_request')) return;` - URL wins over Accept header
2. Checks Accept header: `$accept = $_SERVER['HTTP_ACCEPT'] ?? '';`
3. Returns early if `text/markdown` not found in Accept header (simple strpos check suffices)
4. Gets canonical URL using a helper method `get_current_canonical_url()`
5. Builds .md URL: `$md_url = rtrim($canonical, '/') . '.md';`
6. Issues 303 redirect with Vary header:
   ```php
   status_header(303);
   header('Vary: Accept');
   header('Location: ' . $md_url);
   exit;
   ```

Add private helper `get_current_canonical_url()` that:
- For singular posts/pages: uses `get_permalink(get_queried_object())`
- For category/tag archives: uses `get_term_link(get_queried_object())`
- For author archives: uses `get_author_posts_url(get_queried_object_id())`
- For date archives: uses `get_year_link()`, `get_month_link()`, `get_day_link()`
- Returns null if no canonical URL can be determined

Register the hook in `register()` method - add BEFORE the existing template_redirect hook but at same priority 1:
```php
add_action('template_redirect', [$this, 'handle_accept_negotiation'], 1);
```

This ensures Accept check happens first (registered first, runs first at same priority).

Reference 03-RESEARCH.md Pattern 1 and Pattern 4 for implementation.
  </action>
  <verify>
Read the updated RewriteHandler.php and confirm:
- `handle_accept_negotiation()` method exists
- `get_current_canonical_url()` helper exists
- Hook registration includes both template_redirect handlers at priority 1
- 303 status code is used (not 301 or 302)
- Vary: Accept header is set on redirect response
  </verify>
  <done>Accept header on HTML URL returns 303 redirect to .md URL; archives and singular content supported</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Code review:
   - `set_response_headers()` sets all 4 headers
   - `handle_accept_negotiation()` checks markdown_request first (URL wins)
   - 303 redirect includes Vary: Accept header
   - `get_current_canonical_url()` handles singular and archive types

2. Curl tests (if WordPress environment available):
   ```bash
   # Test Accept header redirect
   curl -I -H "Accept: text/markdown" http://localhost/sample-post/ | grep -E "HTTP|Location|Vary"
   # Expected: HTTP/1.1 303, Location: .../sample-post.md, Vary: Accept

   # Test markdown response headers
   curl -I http://localhost/sample-post.md | grep -E "Content-Type|Vary|Link|X-Content-Type"
   # Expected: All 4 headers present
   ```
</verification>

<success_criteria>
- RewriteHandler.php contains `set_response_headers()` and `handle_accept_negotiation()` methods
- Markdown responses include Vary: Accept, Link, and X-Content-Type-Options headers
- Accept: text/markdown on HTML URL returns 303 redirect to .md URL
- URL always wins over Accept header (markdown_request check first)
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-negotiation-discovery/03-01-SUMMARY.md`
</output>
