---
phase: 03-content-negotiation-discovery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Discovery/AlternateLinkHandler.php
  - src/Plugin.php
autonomous: true

must_haves:
  truths:
    - "HTML page head contains <link rel='alternate' type='text/markdown'> tag"
    - "Alternate link href points to .md URL"
    - "Alternate link only appears on posts and pages (not unsupported post types)"
  artifacts:
    - path: "src/Discovery/AlternateLinkHandler.php"
      provides: "Alternate link tag injection via wp_head"
      contains: "rel=\"alternate\""
    - path: "src/Plugin.php"
      provides: "Discovery handler wiring"
      contains: "AlternateLinkHandler"
  key_links:
    - from: "src/Plugin.php"
      to: "src/Discovery/AlternateLinkHandler.php"
      via: "instantiation in constructor"
      pattern: "new AlternateLinkHandler"
    - from: "AlternateLinkHandler::output_alternate_link()"
      to: "wp_head action"
      via: "add_action in register()"
      pattern: "add_action\\('wp_head'"
---

<objective>
Create AlternateLinkHandler class to inject alternate link tags in HTML page head.

Purpose: Enable programmatic discovery of markdown versions - LLMs and tools can find the .md URL by parsing the HTML head for `<link rel="alternate" type="text/markdown">` tags.

Output: New AlternateLinkHandler class in src/Discovery/ namespace, wired into Plugin.php, outputting alternate links for posts and pages.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-negotiation-discovery/03-CONTEXT.md
@.planning/phases/03-content-negotiation-discovery/03-RESEARCH.md
@src/Plugin.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AlternateLinkHandler class</name>
  <files>src/Discovery/AlternateLinkHandler.php</files>
  <action>
Create a new file at `src/Discovery/AlternateLinkHandler.php` with namespace `MarkdownAlternate\Discovery`.

The class needs:

1. `register()` method - registers `wp_head` hook at priority 5:
   ```php
   add_action('wp_head', [$this, 'output_alternate_link'], 5);
   ```

2. `output_alternate_link()` method - outputs the link tag:
   - Return early if not `is_singular()` (only posts and pages for now, per PROJECT.md scope)
   - Get the queried post object
   - Check post status is 'publish' (no link for drafts/private)
   - Check post type is 'post' or 'page' (supported types only)
   - Build .md URL: `rtrim(get_permalink($post), '/') . '.md'`
   - Output: `<link rel="alternate" type="text/markdown" href="{url}" />\n`
   - Use `esc_url()` for the href value

3. Add proper PHPDoc blocks following WordPress standards.

Reference 03-RESEARCH.md Pattern 2 for implementation, but simplified to singular content only (archives are Claude's discretion per CONTEXT.md - skip for now to keep scope focused).

Include standard file header comment with @package MarkdownAlternate.
  </action>
  <verify>
Read src/Discovery/AlternateLinkHandler.php and confirm:
- Namespace is `MarkdownAlternate\Discovery`
- `register()` method adds wp_head action
- `output_alternate_link()` checks is_singular(), post status, post type
- Link tag uses `rel="alternate"` and `type="text/markdown"`
- URL is escaped with `esc_url()`
  </verify>
  <done>AlternateLinkHandler class exists with proper wp_head hook registration and link output</done>
</task>

<task type="auto">
  <name>Task 2: Wire AlternateLinkHandler into Plugin</name>
  <files>src/Plugin.php</files>
  <action>
Update src/Plugin.php to instantiate and register AlternateLinkHandler:

1. Add use statement:
   ```php
   use MarkdownAlternate\Discovery\AlternateLinkHandler;
   ```

2. Add private property:
   ```php
   /**
    * Discovery handler instance.
    *
    * @var AlternateLinkHandler
    */
   private $discovery;
   ```

3. In constructor, instantiate and register after router:
   ```php
   $this->discovery = new AlternateLinkHandler();
   $this->discovery->register();
   ```

Follow the existing pattern from router instantiation.
  </action>
  <verify>
Read src/Plugin.php and confirm:
- Use statement for AlternateLinkHandler is present
- Private $discovery property declared
- Constructor instantiates and calls register() on AlternateLinkHandler
  </verify>
  <done>AlternateLinkHandler is wired into plugin lifecycle and will output alternate links on page load</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Code structure:
   - File exists: src/Discovery/AlternateLinkHandler.php
   - Namespace: MarkdownAlternate\Discovery
   - Class registered in Plugin.php constructor

2. Composer autoload (if needed):
   ```bash
   composer dump-autoload
   ```
   Note: PSR-4 autoloading should pick up new namespace automatically since it maps MarkdownAlternate\ to src/

3. HTML verification (if WordPress environment available):
   - Visit a published post's HTML page
   - View source, search for `rel="alternate"`
   - Confirm link tag present with type="text/markdown" and correct .md href
</verification>

<success_criteria>
- src/Discovery/AlternateLinkHandler.php exists with register() and output_alternate_link() methods
- Plugin.php imports and instantiates AlternateLinkHandler
- HTML pages for published posts/pages include alternate link tag in head
- Alternate link correctly points to .md URL
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-negotiation-discovery/03-02-SUMMARY.md`
</output>
